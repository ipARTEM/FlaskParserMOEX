{% extends "base.html" %}
{% from "heatmap.html" import render_grid %}


{% block content %}
<div class="toolbar" style="gap:.5rem; flex-wrap:wrap">
  <a class="btn" href="{{ url_for('market.parser_page', mode='fast') }}">Обновить (fast)</a>
  <a class="btn" href="{{ url_for('market.parser_page', mode='fresh', admin_token=request.args.get('admin_token','')) }}">Обновить (fresh)</a>
  <a class="btn" href="{{ url_for('market.snapshot_latest') }}">Снимок из БД (последний)</a>
  <a class="btn" href="{{ url_for('market.snapshots_list') }}">Все снимки из БД</a>


  <form method="get" action="{{ url_for('market.snapshot_latest') }}" style="display:flex; gap:.5rem; align-items:center">
    <input type="text" name="at" placeholder="YYYY-MM-DD или YYYY-MM-DD HH:MM" style="padding:.4rem .6rem">
    <button class="btn" type="submit">Показать на момент</button>
  </form>

  <a class="btn" href="{{ url_for('market.snapshot_csv') }}">Экспорт CSV</a>
</div>

<h2>Акции (TQBR)</h2>
{{ render_grid(stock_tiles) }}
<div class="grid">
  {% for t in stock_tiles %}
    <div class="tile" title="{{ t.secid }}: {{ t.last }}">
      <div class="tile-head">{{ t.secid }}</div>
      <div class="tile-name">{{ t.name }}</div>
      <div class="tile-num">{{ "%.2f"|format(t.change) if t.change is not none else "—" }}%</div>
    </div>
  {% endfor %}
</div>

<h2>Фьючерсы (RFUD)</h2>
{{ render_grid(fut_tiles) }}
<div class="grid">
  {% for t in fut_tiles %}
    <div class="tile" title="{{ t.secid }}: {{ t.last }}">
      <div class="tile-head">{{ t.secid }}</div>
      <div class="tile-name">{{ t.name }}</div>
      <div class="tile-num">{{ "%.2f"|format(t.change) if t.change is not none else "—" }}%</div>
    </div>
  {% endfor %}
</div>

{% endblock %}

{% if not stock_tiles and not fut_tiles %}
  <p>В БД пока нет снимков. Нажмите «Обновить (fresh)», чтобы сохранить свежие данные.</p>
{% endif %}

